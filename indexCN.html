<!-- Licensed under a BSD license. See license.html for license -->
<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<!-- <title>test</title> -->
	<!-- <link type="text/css" href="resources/webgl-tutorials.css" rel="stylesheet" /> -->
	<style>
		html,
		body {
			width: 100%;
			height: 100%;
			/* overflow: auto; */
			background: #fff;

		}

		/* body{
			position:fixed;
			top: 0;
			left: 0;
			display: flex;
			flex-direction: column;
			overflow-y:auto;

		} */

		canvas {
			width: 704px;
			height: 576px;
			margin: 2px;
			border: 1px solid black;
		}

		.grid-box {
			display: flex;
			flex-wrap: wrap;
			position: absolute;
			width: 712px;
			height: 584px;
			z-index: 1000;
		}

		.grid-box .item {
			box-sizing: border-box;
			border: 1px solid white;
			background: rgba(0, 0, 0, 0.3);
			pointer-events: none;
		}

		.grid-box .area {
			position: absolute;
			pointer-events: none;
		}
	</style>
	<script src="./decoder_def.js"></script>
	<script src="./jadecoder.js"></script>
	<script src="./hevcdec.js"></script>
	<script src="./glutils.js"></script>
	<script src="./connector.js"></script>
	<script src="./audioplay.js"></script>
	<script src="./md5.js"></script>
	<script>
	</script>
</head>

<body onload="init()">
	<span>设备ID：</span>
	<!--input type="text" id="dev_id" value="2691361432"-->
	<!--input type="text" id="dev_id" value="5587063385"-->
	<!-- <input type="text" id="dev_id" value="3249598401"> -->
	<input type="text" id="dev_id" value="">
	<span>用户名：</span>
	<input type="text" id="user" value="admin">
	<span>密码：</span>
	<!--input type="text" id="pwd" value="826888lh"-->
	<!--input type="text" id="pwd" value="2461bba99b12e653c51dc15d88dc80c8"-->
	<input type="text" id="pwd" value="">
	<select id="streamtype" style="width:100px">
		<option value=0>主码流</option>
		<option value=1 selected>子码流</option>
	</select>
	<select id="channel" style="width:100px">
		<option value=0>通道1</option>
		<option value=1>通道2</option>
		<option value=2>通道3</option>
		<option value=3>通道4</option>
	</select>
	<button onclick="onGetSN()">查询SN</button>
	<span id="dev_sn"></span>
	<button onclick="onReboot()">重启设备</button>
	<button onclick="onTest()">压力测试</button>
	<button onclick="onMD5()">MD5</button>
	<button onclick="onDomainTest()">Domain压测</button>
	<br />
	<span>预览</span>
	<br />
	<button onclick="connect()" style="width:100px">连接设备</button>
	<button onclick="disconnect()" style="width:100px">断开连接</button>
	<button onclick="openvideo()" style="width:100px">打开码流</button>
	<!--button onclick="playnext()" style="width:100px">next video</button-->
	<button onclick="changestream()" style="width:110px">切换码流</button>
	<button onclick="closevideo()" style="width:100px">关闭码流</button>
	<button onclick="snapshot()" style="width:100px">截图</button>	

	<button onclick="openaudio()" style="width:100px">打开音频</button>
	<button onclick="closeaudio()" style="width:100px">关闭音频</button>	

	<button onclick="deviceAlarm()" style="width:100px">报警</button>
	<button onclick="deviceAlarm_stop()" style="width:100px">关闭报警</button>

	<button onclick="setMainStreamH264()">设置主码流为H264</button>
	<button onclick="setSubStreamH264()">设置子码流为H264</button>
	<button onclick="getStreamType()">获取编码格式</button><span id="streamType"></span>
	<!-- <button onclick="showPlayInfo()" style="width:100px">show playinfo</button> -->
	
	<button  onclick="startRecord()" style="width:100px">开始录像</button>
	<button   onclick="endRecord()" style="width:100px">结束录像</button>
	<br />
	<input type="checkbox" id="flipEnabled">图像上下翻转  <input type="checkbox" id="mirrorEnabled">图像左右翻转
	<button onclick="getVideoManager()" style="width:100px">获取</button>
	<button onclick="setVideoManager()" style="width:100px">设置</button>
	<br>	
	<span>云台控制</span>
	<br />
	<button onmouseup="ptz_ctrl_stop()" onmousedown="ptz_ctrl_up()" style="width:100px">云台上</button>
	<button onmouseup="ptz_ctrl_stop()" onmousedown="ptz_ctrl_down()" style="width:100px">云台下</button>
	<button onmouseup="ptz_ctrl_stop()" onmousedown="ptz_ctrl_left()" style="width:100px">云台左</button>
	<button onmouseup="ptz_ctrl_stop()" onmousedown="ptz_ctrl_right()" style="width:100px">云台右</button>
	<button onmouseup="ptz_ctrl_stop()" onmousedown="ptz_ctrl_zoom_in()" style="width:100px">云台近</button>
	<button onmouseup="ptz_ctrl_stop()" onmousedown="ptz_ctrl_zoom_out()" style="width:100px">云台远</button>
	<button onclick="ptz_ctrl_check()" style="width:100px">云台校准</button>
	预置位：<input type="text" id="presetName" value="1" style="width:100px">
	<button onmousedown="ptz_ctrl_set_preset()" style="width:100px">设置预置点</button>
	<button onmousedown="ptz_ctrl_load_preset()" style="width:100px">调用预置点</button>
	<button onmousedown="ptz_ctrl_clear_preset()" style="width:100px">清空预置点</button>
	<br />
	<span>语音对讲</span>
	<br />
	<button onclick="opencall()" style="width:100px">发起对讲</button>
	<button onclick="speakingcall()" style="width:100px">开始讲话</button>
	<button onclick="stopspeaking()" style="width:100px">停止讲话</button>
	<button onclick="closecall()" style="width:100px">关闭对讲</button>
	<br />
	<span>回放</span>
	<span>当前回放录像时间</span>
	<span id="startTime"></span>
	<span>-</span>
	<span id="endTime"></span>
	<br />
	<button onclick="searchrecord()" style="width:100px">搜索录像</button>
	<button onclick="playback(0)" style="width:120px">回放第一个录像</button>
	<button onclick="playbacknext()" style="width:120px">回放下一个录像</button>
	<button onclick="playbackprev()" style="width:120px">回放上一个录像</button>
	<button onclick="playbackpause()" style="width:100px">暂停回放</button>
	<button onclick="playbackcontinue()" style="width:100px">继续回放</button>
	<button onclick="playback(1)" style="width:120px">下载录像</button>
	<button onclick="stopplayback()" style="width:100px">停止回放</button>
	<div style="top:100px;float:left;position:absolute;width:500px;height:500px;background-color:#EEE;margin:10px;padding:10px;display:none;border:1px solid blue" id="div_recList">
	<div>
	<span>录像列表</span>&nbsp;&nbsp;<a href="#" onclick="document.getElementById('div_recList').style.display='none';">关闭</a>
	</div>
	<div style="height:470px;overflow: auto;">
	<table id="recListTable" style="border:solid 1px black">
		<tr>
			<td style="border:solid 1px black">序号</td>
			<td style="border:solid 1px black">开始时间</td>
			<td style="border:solid 1px black">结束时间</td>
			<td style="border:solid 1px black">时长(秒)</td>
			<td style="border:solid 1px black">录像类型</td>
			<td style="border:solid 1px black">下载录像</td>
			<td style="border:solid 1px black">回放</td>
		</tr>
	</table>	
	</div>	
	</div>
	<br />
	<input type="text" value="2023-11-03 08:42:00" id="playback_time">
	<button onclick="playback_byTime()">指定时间回放</button>&nbsp;&nbsp;&nbsp;&nbsp;
	<!--
	<button onclick="playback_playFast()">快放</button>&nbsp;&nbsp;&nbsp;&nbsp;
	<button onclick="playback_playSlow()">慢放</button>&nbsp;&nbsp;&nbsp;&nbsp;
	<button onclick="playback_playNormal()">正常播放</button>&nbsp;&nbsp;&nbsp;&nbsp;
	-->
	<button onclick="document.getElementById('div_recList').style.display=''">显示录像列表</button>
	<br>
	<span>报警录像时长：</span>
	<input type="text" value="10" id="alarm_rec_time">
	<button onclick="getAlarmRecTime()">获取</button>
	<button onclick="setAlarmRecTime()">设置</button>
	<br>
	<button onclick="remoteSetup()" style="width:130px">获取远程设置参数</button>
	<button onclick="getDeviceVolume()" style="width:100px">获取音量</button>
	输入音量：<span id="device_VolumeInput" style="width:100px;text-align: center;">0</span>
	输出音量：<span id="device_VolumeOutput" style="width:100px;text-align: center;">0</span>
	<button onclick="setDeviceVolume()" style="width:100px">设置音量</button>
	<input type="text" id="device_SetVolume" style="width:80px" value="80">
	<br>
	<span>卡类型：</span><span id="OperatorsName"></span>&nbsp;&nbsp;&nbsp;&nbsp;
	<span>信号：</span><span id="Signal"></span>
	<br>
	<input type="checkbox" id="ir"> 红外夜视模式
	<button onclick="getIR()" style="width:100px">获取</button>
	<button onclick="setIR()" style="width:100px">设置</button>
	<input type="checkbox" id="light"> 全彩夜视模式
	<button onclick="getLight()" style="width:100px">获取</button>
	<button onclick="setLight()" style="width:100px">设置</button>

	<input type="checkbox" id="autolight"> 智能模式
	<button onclick="getAutoLight()" style="width:100px">获取</button>
	<button onclick="setAutoLight()" style="width:100px">设置</button>
	<br>
	<input type="checkbox" id="warningTone"> 扩音器报警开关
	<button onclick="getWarningTone()" style="width:100px">获取</button>
	<button onclick="setWarningTone()" style="width:100px">设置</button>	
	<br>
	<div>
		<span>TF卡状态：</span><span id="tf_status" style="width:80px;display:inline-block"></span>&nbsp;&nbsp;<span>TF卡容量：</span><span id="tf_totalSize" style="width:100px;display:inline-block"></span>&nbsp;&nbsp;<span>剩余：</span><span id="tf_leaveSize" style="width:100px;display:inline-block"></span>
		&nbsp;&nbsp;&nbsp;&nbsp;
		<button onclick="getTFCardStatus()">获取TF卡状态</button>
		&nbsp;&nbsp;
		<button onclick="formatTFCard()">格式化TF卡</button>
	</div>
	<div>
		<button id="get_rec_mode" onclick="getRecordMode()">获取当前录像模式</button>
		&nbsp;&nbsp;&nbsp;
		<button id="set_rec_mode" onclick="setRecordMode()">设置录像模式</button>
		<select id="rec_mode_list">
			<option value="ultraLowPowerMode">固定时长</option>
			<option value="lowPowerMode">持续录像</option>
			<option value="autoLongAliveMode">一直录像</option>
		</select>
	</div>
	<div>
		<input type="checkbox" id="motionTrackEnabled">移动跟踪开关 &nbsp;&nbsp;<button onclick="getMotionTrackEnabled()">获取</button>&nbsp;&nbsp;<button onclick="setMotionTrackEnabled()">设置</button>
	</div>
	<div>
		<input type="checkbox" id="AudioEnabled">录制声音开关 &nbsp;&nbsp;<button onclick="getAudioEnabled()">获取</button>&nbsp;&nbsp;<button onclick="setAudioEnabled()">设置</button>
	</div>	
	<div>
		<label>设备使用场景</label><button onclick="getUsageScenario()">获取</button><button onclick="setUsageScenario()">设置</button>
		<select id="usageScenario">			
			<option value=""></option>
			<option value="indoor">室内</option>
			<option value="outdoor">室外</option>
		</select>
	</div>
	<!--
        <div>
		<label>画面侦测区</label>
		<button id="pic_detect_line_mode" onclick="drawAreaMode()">区域模式</button>
		<button id="pic_detect_area_mode" onclick="drawLineMode()">划线模式</button>
	</div>
-->
	<div>
		<span>区域侦测设置</span>
		<br>
		<button id="pic_detect_line_mode" onclick="drawAreaMode()">选择区域</button>
		<button  onclick="closeDrawArea()">关闭选择区域</button>
		<br>
		<span>按住鼠标左键，在下面方格框中侦测区域，然后点击'设置区域侦测'</span>
		<br>
		<span>区域模式：侦测区内有物体移动，则触发智能侦测警报</span>
		<!-- 暂时屏蔽，目前先支持区域模式
	<span>模式</span>        
	<select id="motion_detection_mode_list">
		<option value="region">区域模式</option>
		<option value="line">警戒线模式</option>
	</select>
	<br>
	<span>区域模式：侦测区内有物体移动，则触发智能侦测警报</span>
	<br>
	<span>警戒线模式: 当有移到物体触碰警戒线，则触发智能侦测警报</span>
	-->
		<br>
		<button id="set_motion_detection_region" onclick="setRegionMotionDetection()">设置区域侦测</button>
	</div>

	<!-- <button onclick="playback()" style="width:100px">play back</button> -->
	<!-- <button onclick="stopplayback()" style="width:100px">stop playback</button> -->
	<!-- <button onclick="playback_pause()" style="width:100px">pause/continue</button> -->
	<!-- <button onclick="playback_fast()" style="width:100px">fast</button> -->
	<!-- <button onclick="playback_slow()" style="width:100px">slow</button> -->
	<!-- <button onclick="playback_reset()" style="width:100px">reset</button> -->
	

	<table style="border:0px; width:720px">
		<tr>
			<td>
				<canvas id="canvas1" width="702" height="576"></canvas>
			</td>
			<!-- <td>
                    <canvas id="canvas2"></canvas>
            </td> -->
		</tr>
		<!-- <tr>
                <td>
                        <canvas id="canvas3"></canvas>
                </td>
                <td>
                        <canvas id="canvas4"></canvas>
                </td>
            </tr>         -->
			<div class="grid-box" id="gridBox" onmousedown="getStartPoint()" onmouseup="getEndPoint()">

				<div class="area" id="area"></div>
			</div>
	</table>


</body>
<script src="./play.js"></script>
<script>

	function onGetSN(){
		var devId = document.getElementById("dev_id").value;

		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function(){
			if(xhr.readyState === 4){
				if(xhr.status === 200){
					console.log(xhr.responseText);
					var res = JSON.parse(xhr.responseText);
					var sign_str = res.nonce.toUpperCase() + devId + res.request_id.toUpperCase() + "Japass^2>.j";
					var sign = stringChangeMd5(sign_str);

					var xhr1 = new XMLHttpRequest();
					xhr1.onreadystatechange = function(){
						if(xhr1.readyState === 4){
							if(xhr1.status === 200){
								console.log(xhr1.responseText);
								var sn = JSON.parse(xhr1.responseText)
								document.getElementById("dev_sn").innerText = sn.sn;
							}
						}
					}
					var url1 = "https://openapi.dvr163.com/device/device?method=get_sn&id=" + devId + "&request_id=" + res.request_id + "&verify=" + sign;
					xhr1.open("GET", url1);
					xhr1.send();
				}
			}
		}
		var url = "https://openapi.dvr163.com/message/nonce?method=get";
		xhr.open("GET", url);
		xhr.send();
	}

	var resolv_checkUID = function(sn){
		if(sn.length <= 10){
			console.log(sn);
			return sn;
		}

		var startIndex = sn.length - 10;
		for(var i = startIndex; i<= sn.length; i++){
			if(sn.charAt(i) != "0"){
				startIndex = i;
				break;
			}
		}
		console.log(sn.substr(startIndex));
		return sn.substr(startIndex);
	}

	var resolv_batchNum = function(yearStr, monStr){
    var mYear = this.resolv_decodeDiffYear(yearStr);
    var mYear_Mon = this.resolv_decodeMonth(mYear, monStr);
    return resolv_Date(mYear_Mon.year, mYear_Mon.mon);
}

var resolv_decodeDiffYear = function(year_str){
    var year_code = year_str.charCodeAt(0);
    if(year_code < 58) return year_code - 48;
    if(year_code < 91) return year_code - 55;
    return year_code - 61;
}

var resolv_decodeMonth = function(yearCode, month_str){
    var month_code = month_str.charCodeAt(0);
    var ret = 0;
    if(month_code == 48){
        //return resolv_decodeMonth(yearCode, 'z') + 1;
		var result = resolv_decodeMonth(yearCode, 'z');
		result.mon += 1;
		return result;
    }
    else if((month_code > 48) && (month_code < 58)){
        ret = month_code - 48;
    }
    else if(month_code < 91){
        ret = month_code - 55;
    }
    else {
        ret = month_code - 61;
    }

    var retMod = ret % 12;
    var times = Math.floor(ret / 12);
    if(retMod == 0){
        retMod = 12;
        times = times - 1;
    }

    var diffYear = times * 62 + yearCode + 2010;
    return {"year":diffYear,"mon":retMod};
}

var resolv_Date = function(mYear, mMon){
    if(mYear < 2023) return 0;
    if((mYear == 2023) && (mMon < 5)) return 0;
    if(mYear < 2320) return (mYear - 2024) * 12 + 8 + mMon;
    return (2320-2024) * 12 + 8 + (mYear - 2320) * 2 + mMon;
}

/**
 * 根据SN确定寻址的域名
 * @param {*} sn 
 */
var resolv_domain = function(sn, usehttps){
    if(sn.length > 10){
        var yearStr = sn.substr(sn.length - 12, 1);
        var monStr = sn.substr(sn.length - 11, 1);
        var ngwIndex = this.resolv_batchNum(yearStr, monStr);

        var port = 80;
        if(usehttps)port = 443;

        var domain = "ngw-cli.dvr163.com";
        if(ngwIndex > 0){
            domain = "ngw-cli-" + ngwIndex + ".dvr163.com";
        }

        return {"domain":domain,"port":port}
    }
    else{
        if(usehttps){
            return {"domain":"ngw-cli.dvr163.com","port":443};
        }
        else{
            return {"domain":"ngw-cli.dvr163.com","port":80};
        }
    }
}	

	function onDomainTest(){
		var devId = document.getElementById("dev_id").value;

		//console.log(resolv_checkUID(devId));
		var domainFirstChar = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";

		var domainSecondChar = "123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0";

		var loopCount = Math.ceil(domainSecondChar.length / 12);
		var secondIndex = 0;
		var printIndex = 1;

		for(var i = 0; i < loopCount; i++){
			for(var j = 0; j< domainFirstChar.length; j++){
				var count = domainSecondChar.length - secondIndex;
				if(count > 12){
					count = 12;
				}
				else{
					count = domainSecondChar.length - secondIndex;
				}
				for(var k = 0; k < count; k++){
					var domain_str = domainFirstChar.substr(j, 1) + domainSecondChar.substr(k + secondIndex, 1);
					if(domain_str == "00"){
						console.log("------------------------------");
					}
					var sn = "JAAA" + domain_str + devId;
					let domain = resolv_domain(sn, true);
					domain.key = domain_str;
					console.log(printIndex, domain);
					printIndex++;
				}
			}
			secondIndex += 12;
		}
	}
		
	function onMD5(){
		var devId = document.getElementById("dev_id").value;

		var str = stringChangeMd5(devId);
		console.log("md5", str)
	}

	// var last_rec_time = 0;
	// ConnectApi.onRecordFetch = function(file_type, file_begintime, file_endtime){
	// 	if(file_endtime - file_begintime <= 0){
	// 		return;
	// 	}
	// 	var tr = document.createElement("tr");
	// 	var td_begin = document.createElement("td");
	// 	var td_end = document.createElement("td");
	// 	var td_times = document.createElement("td");
	// 	var td_type = document.createElement("td");

	// 	td_begin.innerText = new Date((file_begintime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();	
	// 	td_end.innerText = new Date((file_endtime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
	// 	td_times.innerText = file_endtime - file_begintime;
	// 	if(file_type == 1){
	// 		td_type.innerText = "日程录像"
	// 	}
	// 	else{
	// 		td_type.innerText = "报警录像";
	// 	}		

	// 	if(file_begintime == last_rec_time){
	// 		tr.style.background = "blue"
	// 	}
	// 	last_rec_time = file_begintime;

	// 	td_begin.style = "border:solid 1px black"
	// 	td_end.style = "border:solid 1px black"
	// 	td_times.style = "border:solid 1px black"
	// 	td_type.style = "border:solid 1px black"

	// 	tr.appendChild(td_begin);
	// 	tr.appendChild(td_end);
	// 	tr.appendChild(td_times);
	// 	tr.appendChild(td_type);

	// 	var recListTable = document.getElementById("recListTable");
	// 	recListTable.appendChild(tr);
	// }

	// ConnectApi.onRecFrameTimestamp = function(timestamp){
	// 	//console.log(timestamp);
	// 	//console.log(new Date().getTimezoneOffset());
	// 	document.getElementById("playback_time").value = new Date((timestamp + new Date().getTimezoneOffset() *60 * 1000)).toLocaleString();	
	// }
	var girdData = null
	window.girdData = girdData
	ConnectApi.onRemoteSetup = function(remote_str){
		console.log(remote_str)
		var config = JSON.parse(remote_str);

		if(config.option){
			if(config.option == "success"){
				alert("设置成功");
			}
			else{
				alert("设置失败")
			}
		}

		if(config.IPCam){
			if(config.IPCam.videoManager){
				if(config.IPCam.videoManager.streamId == 1){
					var streamType = document.getElementById("streamType");
					streamType.innerText = "主码流：" + config.IPCam.videoManager.encType
				}
				if(config.IPCam.videoManager.streamId == 2){
					var streamType = document.getElementById("streamType");
					streamType.innerText = "子码流：" + config.IPCam.videoManager.encType
				}				
			}
			if(config.IPCam.ModeSetting){
				if(config.IPCam.ModeSetting.AudioVolume){
					var obj_out = document.getElementById("device_VolumeInput");
					obj_out.innerText = config.IPCam.ModeSetting.AudioVolume.AudioInputVolume;

					var obj_out = document.getElementById("device_VolumeOutput");
					obj_out.innerText = config.IPCam.ModeSetting.AudioVolume.AudioOutputVolume;
				}

				document.getElementById("AudioEnabled").checked = config.IPCam.ModeSetting.AudioEnabled;

				if(config.IPCam.ModeSetting.IRCutFilterMode){
					switch(config.IPCam.ModeSetting.IRCutFilterMode){
						case "ir":
							document.getElementById("ir").checked = (config.IPCam.ModeSetting.IRCutFilterMode == "ir");
							break;
						case "light":
							document.getElementById("light").checked = (config.IPCam.ModeSetting.IRCutFilterMode == "light");
							break;
						case "auto":
							document.getElementById("autolight").checked = (config.IPCam.ModeSetting.IRCutFilterMode == "auto");
							break;
					}
				}
				if(config.IPCam.ModeSetting.usageScenario){
					document.getElementById("usageScenario").value = config.IPCam.ModeSetting.usageScenario;
				}
			}

			if(config.IPCam.videoManager){
				document.getElementById("flipEnabled").checked = config.IPCam.videoManager.flipEnabled;
				document.getElementById("mirrorEnabled").checked = config.IPCam.videoManager.mirrorEnabled;
			}

			if(config.IPCam.WorkMode){
				document.getElementById("rec_mode_list").value = config.IPCam.WorkMode.Mode;
			}
			
			if(config.IPCam.AlarmSetting){
				if(config.IPCam.AlarmSetting.MotionDetection){
					document.getElementById("warningTone").checked = config.IPCam.AlarmSetting.MotionDetection.MotionWarningTone;
					document.getElementById("motionTrackEnabled").checked = config.IPCam.AlarmSetting.MotionDetection.motionTrackEnabled;
					if(config.IPCam.AlarmSetting.MotionDetection.MdRecDuration){
						document.getElementById("alarm_rec_time").value = config.IPCam.AlarmSetting.MotionDetection.MdRecDuration;
					}

					if(JSON.stringify(config.IPCam.AlarmSetting.MotionDetection.grid)!=JSON.stringify([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0])){
						console.log("设置了网格区域侦测")
						window.girdData = JSON.parse(JSON.stringify(config.IPCam.AlarmSetting.MotionDetection.grid))
						
					}					
				}
			}
			if(config.IPCam.TfcardManager){
				var tf_status = document.getElementById("tf_status");
				var tf_totalSize = document.getElementById("tf_totalSize");
				var tf_leaveSize = document.getElementById("tf_leaveSize");
				tf_status.innerText = config.IPCam.TfcardManager.Status;
				tf_totalSize.innerText = config.IPCam.TfcardManager.TotalSpacesize + "M";
				tf_leaveSize.innerText = config.IPCam.TfcardManager.LeaveSpacesize + "M";
			}
			if(config.IPCam.Lte){
				var OperatorsName = document.getElementById("OperatorsName");
				var Signal = document.getElementById("Signal");
				OperatorsName.innerText = config.IPCam.Lte.OperatorsName;
				Signal.innerText = config.IPCam.Lte.Signal;
			}
		}
	}
	var playbackNum = 0;
	var recorder = null
	var splitdata = new window.JASplitData()
	function test_clock_ms() {
		return (new Date()).valueOf();
	}

	function onCloseVideo(){
		closevideo();
		disconnect();
		window.setTimeout(onTest, 2000);
	}

	function onOpenVideo(){
		openvideo();

		window.setTimeout(onCloseVideo, 3000);
	}

	function onTest(){
		connect();
		window.setTimeout(onOpenVideo, 3000);
	}

	function getStreamType(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"videoManager":{
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);			
	}

	function setSubStreamH264(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		
		var flip = document.getElementById("flipEnabled");
		var mirror = document.getElementById("mirrorEnabled");

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"videoManager":{
					"streamId":2,
					"encType":"H.264",
					"flipEnabled":flip.checked,
					"mirrorEnabled":mirror.checked					
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);			
	}

	function setMainStreamH264(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;	
		var flip = document.getElementById("flipEnabled");
		var mirror = document.getElementById("mirrorEnabled");

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"videoManager":{
					"streamId":1,
					"encType":"H.264",
					"flipEnabled":flip.checked,
					"mirrorEnabled":mirror.checked
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);	
	}

	function getUsageScenario(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"ModeSetting":{
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);			
	}

	function setUsageScenario(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		
		if(document.getElementById("usageScenario").value == ""){
			return;
		}

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"ModeSetting":{
					"usageScenario":document.getElementById("usageScenario").value
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);				
	}

	function getMotionTrackEnabled(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"AlarmSetting":{
					"MotionDetection":{

					}
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);	
	}

	//sensitivity opt ["lowest","low","normal","high","highest"]
	// function setMotionSensitivity(){
	// 	var user = document.getElementById("user").value;
	// 	var pwd = document.getElementById("pwd").value;		

	// 	let config = {
	// 		"Version": "1.3.0",
	// 		"Method": "set",
	// 		"IPCam": {
	// 			"AlarmSetting":{
	// 				"MotionDetection":{
	// 					"SensitivityLevel":"nomral"
	// 				}
	// 			}
	// 		},
	// 		"Authorization": {
	// 			"Verify": '',
	// 			"username": user,
	// 			"password": pwd
	// 		}
   	// 	 };

	// 	sendRemoteConfig(config);	
	// }	

	function setMotionTrackEnabled(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"AlarmSetting":{
					"MotionDetection":{
						"motionTrackEnabled":document.getElementById("motionTrackEnabled").checked
					}
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);	
	}

	function getAudioEnabled(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"ModeSetting":{
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);		
	}

	function setAudioEnabled(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"ModeSetting":{
					"AudioEnabled":document.getElementById("AudioEnabled").checked
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);		
	}

	function getRecordMode(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"WorkMode":{
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);				
	}

	function setRecordMode(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"WorkMode":{
					"Mode":document.getElementById("rec_mode_list").value
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);				
	}	
	
	function onReboot(){
	  var user = document.getElementById("user").value;
	  var pwd = document.getElementById("pwd").value;			
      var config = {
        "Version":"1.3.0",
        "Method":"set",
        "Authorization":{
          "Verify":"",
          "username":user,
          "password":pwd
        },
        "IPCam":{
          "SystemOperation":{
            "Reboot":true
          }
        }
      }	
	  sendRemoteConfig(config);
	}

	function getAlarmRecTime(){
		var alarm_rec_time = document.getElementById("alarm_rec_time");
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"AlarmSetting":{
					"MotionDetection":{

					}
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);		
	}

	function setAlarmRecTime(){
		var alarm_rec_time = document.getElementById("alarm_rec_time");
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"AlarmSetting":{
					"MotionDetection":{
						"MdRecDuration":parseInt(alarm_rec_time.value)
					}
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);				
	}

	function sendRemoteConfig(config){
		var id = document.getElementById("dev_id").value;
		let session = null;
		session = GetSessionById(id);
		var str = JSON.stringify(config);
		if (session) {
			ConnectApi.remote_setup2(session, str)
		}	
	}

	function getWarningTone(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"AlarmSetting":{
					"MotionDetection":{

					}
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);
		
	}	

	function setWarningTone(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"AlarmSetting":{
					"MotionDetection":{
						"MotionWarningTone":document.getElementById("warningTone").checked
					}
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);
		
	}		

	function getIR(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"ModeSetting":{
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);
		
	}	

	function setIR(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"ModeSetting":{
					"IRCutFilterMode":"ir"
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		 if(document.getElementById("ir").checked){
			config.IPCam.ModeSetting.IRCutFilterMode = "ir";
		 }
		 else{
			config.IPCam.ModeSetting.IRCutFilterMode = "light";
		 }

		sendRemoteConfig(config);
		
	}		

	
	function getLight() {
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"ModeSetting": {
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
		};

		sendRemoteConfig(config);

	}

	function setLight() {
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"ModeSetting": {
					"IRCutFilterMode": "light"
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
		};

		if (document.getElementById("light").checked) {
			config.IPCam.ModeSetting.IRCutFilterMode = "light";
		}
		else {
			config.IPCam.ModeSetting.IRCutFilterMode = "ir";
		}

		sendRemoteConfig(config);

	}

	function getAutoLight() {
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"ModeSetting": {
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
		};

		sendRemoteConfig(config);

	}

	function setAutoLight() {
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"ModeSetting": {
					"IRCutFilterMode": "auto"
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
		};

		sendRemoteConfig(config);

	}

	function getVideoManager(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"videoManager":{
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);
		
	}

	function deviceAlarm(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"V2":{
					"R/SoundManCtrl":{
						"Operate":"ON",
						"DurSec":10,
					}
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);		
	}

	function setVideoManager(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "2.0.0",
			"Method": "set",
			"IPCam": {
				"videoManager":{
					"flipEnabled":document.getElementById("flipEnabled").checked,
					"mirrorEnabled":document.getElementById("mirrorEnabled").checked
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);			
	}

	function getDeviceVolume(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"ModeSetting":{
					"AudioVolume":{

					}
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);
	}

	function setDeviceVolume(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		var volume = parseInt(document.getElementById("device_SetVolume").value);

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"ModeSetting":{
					"AudioVolume":{
						"AudioInputVolume":volume,
						"AudioOutputVolume":volume
					}
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);	
	}

	function remoteSetup(){
		//console.log('开始远处设置', id, ip, str)

		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"ModeSetting": {
				},
				"videoManager":{

				},
				"AlarmSetting":{
					"MotionDetection":{

					}
				},
				"ChannelStatus":{

				},
				"LTE":{

				},
				"TfcardManager":{

				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);
	}

	function getTFCardStatus(){
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"TfcardManager":{

				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };
		sendRemoteConfig(config);		
	}

	function formatTFCard(){
		if(!window.confirm("格式化TF卡，请谨慎操作")){
			return;
		}
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"TfcardManager":{
					"Operation":"format"
				}
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };
		sendRemoteConfig(config);				
	}

	//初始化canvas播放器
	function init() {
		let canvas = document.getElementById("canvas1")
		Player.init([canvas]);
		window.onorientationchange = function() {
          alert(1)
        };
	}

	function connect() {
		// init();
		var devid = document.getElementById("dev_id").value;
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;
		var streamid = parseInt(document.getElementById("streamtype").value);
		var channel = parseInt(document.getElementById("channel").value);
		Player.ConnectDevice(devid, '', user, pwd, 0, 80, 0, channel, streamid, "ws")
	}
	function disconnect(params) {
		var devid = document.getElementById("dev_id").value;
		Player.DisConnectDevice(devid)
	}
	function openvideo() {
		var streamid = parseInt(document.getElementById("streamtype").value);
		var channel = parseInt(document.getElementById("channel").value);
		document.getElementById("channel").disabled = true;
		var devid = document.getElementById("dev_id").value;
		Player.OpenStream(devid, '', channel, streamid, 0);
	}

	function closevideo() {
		
		Player.CloseStream(0)
	}

	function changestream() {
		//closevideo();
		var obj = document.getElementById("streamtype");
		if (obj.value == 0) {
			obj.value = 1;
		} else {
			obj.value = 0;
		}
		//openvideo();
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.ChangeStream(devid, '', channel, obj.value)
	}
	function ptz_ctrl_set_preset(){
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.ptz_ctrl(devid, '', channel, 13, document.getElementById("presetName").value);
	}
	function ptz_ctrl_load_preset(){
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.ptz_ctrl(devid, '', channel, 14, document.getElementById("presetName").value);
	}

	function ptz_ctrl_clear_preset(){
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.ptz_ctrl(devid, '', channel, 15,0);
	}

	function ptz_ctrl_check(){
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.ptz_ctrl(devid, '', channel, 16, 6)
	}

	function ptz_ctrl_up() {
		console.log(1111);
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.ptz_ctrl(devid, '', channel, 2, 6)
	}
	function ptz_ctrl_down() {
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.ptz_ctrl(devid, '', channel, 3, 6)
	}
	function ptz_ctrl_left() {
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.ptz_ctrl(devid, '', channel, 4, 6)
	}
	function ptz_ctrl_right() {
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.ptz_ctrl(devid, '', channel, 5, 6)
	}
	function ptz_ctrl_zoom_in() {
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.ptz_ctrl(devid, '', channel, 8, 6)
	}
	function ptz_ctrl_zoom_out() {
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.ptz_ctrl(devid, '', channel, 9, 6)
	}		
	function ptz_ctrl_stop() {
		console.log(2222);
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.ptz_ctrl(devid, '', channel, 0, 0)
	}
	function searchrecord() {
		var recListTable = document.getElementById("recListTable");
		document.getElementById("div_recList").style.display = "";
		var trList = recListTable.childNodes;
		for(var i=trList.length - 1; i>1 ;i--){
			recListTable.removeChild(trList[i]);
		}
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		var date = new Date()
		var YY = date.getFullYear().toString();
		var MM = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1).toString();
		var DD = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()).toString();
		var begintime = new Date(YY + '-' + MM + '-' + DD + ' 00:00:00');
		var endtime = new Date(YY + '-' + MM + '-' + DD + ' 23:59:59');
		begintime = parseInt(begintime.getTime()/1000) - new Date().getTimezoneOffset() *60
		endtime = parseInt(endtime.getTime()/1000) - new Date().getTimezoneOffset() *60
		
		Player.SreachRecord(devid, '', channel, begintime, endtime, 15)
	}
	function playback_playFast(){
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;		
		Player.PlayFast(devid, '', channel);
	}
	function playback_playSlow(){
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;		
		Player.PlaySlow(devid, '', channel);
	}
	function playback_playNormal(){
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;		
		Player.PlayNormal(devid, '', channel);
	}
	function playback_byTime(){
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;		
		var playback_time = document.getElementById("playback_time").value;
		var startTime = (Date.parse(playback_time)) / 1000 - new Date().getTimezoneOffset() *60; 
		var endTime = startTime + 86400;
		console.log(playback_time + ", " + startTime + "," + endTime);
		Player.StartPlayBack(devid, '', channel, startTime, endTime,255, 0, false, 0);
		//默认为实时模式，根据流来的速度播放
		//设备StreamMode为1时，播放器控制播放帧率，但目前浏览器端效果不好，不建议使用
		//Player.SetStreamMode(devid, '', channel, 1);
		//Player.PlayNormal();		
	}

	
	var overTime = null;

	// function playbacktodown(startTime,endTime,file_type){
	// 	console.log("下载指定时间startTime,endTime,file_type",startTime,endTime,file_type)
	// 	var devid = document.getElementById("dev_id").value;
	// 	var channel = document.getElementById("channel").value;
		
	// 	Player.StartPlayBack(devid, '', channel, startTime,endTime,file_type, 0, false, 1)
	// 	overTime= new Date((endTime+ new Date().getTimezoneOffset()*60 +340 *60) * 1000).valueOf()

	// 	// overTime= new Date((endTime+ new Date().getTimezoneOffset() *60) * 1000).valueOf()
	// 	overTime= new Date((endTime- 318 *60) * 1000).valueOf()
	// 	// overTime= new Date(endTime * 1000).valueOf()
	// 	console.log('index页面的overTime',overTime)
	// 	window.overTime = overTime
	// }

	function playbacktodown(startTime,endTime,file_type){
		console.log("下载指定时间startTime,endTime,file_type",startTime,endTime,file_type)
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		
		Player.StartPlayBack(devid, '', channel, startTime,endTime,file_type, 0, false, 1)

		overTime= new Date((endTime+ new Date().getTimezoneOffset() *60) * 1000).valueOf()
		console.log('index页面的overTime',overTime)
		window.overTime = overTime
	}
	

	function playback(tasktype) {
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		var list = getRecordList();
		playbackNum = 0;
		var startTime = list[playbackNum].file_begintime
		var endTime = list[playbackNum].file_endtime
		// var startTime = list[playbackNum].file_begintime - new Date().getTimezoneOffset() *60
		// var endTime = list[playbackNum].file_endtime - new Date().getTimezoneOffset() *60
		document.getElementById("startTime").innerHTML = new Date((startTime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
		document.getElementById("endTime").innerHTML = new Date((endTime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
		Player.StartPlayBack(devid, '', channel, startTime, endTime,'255', 0, false, tasktype)
	}
	function playbacknext(params) {
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		var list = getRecordList();
		playbackNum = playbackNum + 1;
		var startTime = list[playbackNum].file_begintime
		var endTime = list[playbackNum].file_endtime
		document.getElementById("startTime").innerHTML = new Date((startTime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
		document.getElementById("endTime").innerHTML = new Date((endTime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
		Player.StartPlayBack(devid, '', channel, startTime, endTime,'255', 0, false, 0)
	}
	function playbackprev(params) {
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		var list = getRecordList();
		if(playbackNum > 0){
			playbackNum = playbackNum - 1;
		}
		var startTime = list[playbackNum].file_begintime
		var endTime = list[playbackNum].file_endtime
		document.getElementById("startTime").innerHTML = new Date((startTime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
		document.getElementById("endTime").innerHTML = new Date((endTime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
		Player.StartPlayBack(devid, '', channel, startTime, endTime,'255', 0, false, 0)
	}
	function playbackpause() {
		var devid = document.getElementById("dev_id").value;
		Player.PausePlayBack(devid)
	}
	function playbackcontinue() {
		var devid = document.getElementById("dev_id").value;
		Player.ContinuePlayBack(devid)
	}
	function stopplayback() {
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.StopPlayBack(devid, '', channel)
	}
	function opencall() {
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.OpenCall(devid, '', channel)
	}
	function speakingcall() {
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		if (recorder !== null) recorder.close()
		var recordAudioCallback = function (int16) {
			var unit8data = new Uint8Array(int16.buffer);
			splitdata.feed(unit8data)
		}
		window.JARecorder.get((rec) => {
			recorder = rec
			recorder.start()
		}, {inputCallback: recordAudioCallback})
		splitdata.outputData = function(unit8data){
			Player.CallSend(devid, '', channel, parseInt(new Date().getTime()/1000), 'G711A', 8000, 16, 1, 1, unit8data, unit8data.length)
		}
		
	}
	function stopspeaking() {
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		recorder && recorder.stop()
		splitdata.close()
	}
	function closecall() {
		recorder && recorder.close()
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.CallHangup(devid, '', channel)
	}
	function snapshot() {
		Player.Snapshot(0 , 0,'截图.png', 1280, 720, null)
	}

	function openaudio(){
		Player.OpenAudio(0);
	}

	function closeaudio(){
		Player.CloseAudio(0);
	}

		//触发button下载 
		function downloadVideo(index){
		// console.log(index)
		var videoList = getRecordList()
		var num = index.slice(6)
		// console.log(videoList)
		// console.log(videoList[num])
		// console.log(videoList[videoList.length - num-1])
		// console.log(num)
		// console.log(videoList.length - num-1)
		var startTime = videoList[videoList.length - num-1].file_begintime
		var endTime = videoList[videoList.length - num-1].file_endtime
		document.getElementById("startTime").innerHTML =new Date((startTime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
		document.getElementById("endTime").innerHTML = new Date((endTime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
		// var startTime = videoList[num].file_begintime - new Date().getTimezoneOffset() *60
		// var endTime = videoList[num].file_endtime - new Date().getTimezoneOffset() *60
		// document.getElementById("startTime").innerHTML = new Date((startTime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
		// document.getElementById("endTime").innerHTML = new Date((endTime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
		// var startTime = new Date((videoList[num].file_begintime+ new Date().getTimezoneOffset() *60) * 1000).valueOf()
		// var endTime = new Date((videoList[num].file_endtime+ new Date().getTimezoneOffset() *60) * 1000).valueOf()

		playbacktodown(startTime,endTime,'255')
	}
	ConnectApi.onRecordFetch = function(file_type, file_begintime, file_endtime,INDEX){
		var recListTable = document.getElementById("recListTable");
		
		const newRow = recListTable.insertRow(1);

		const td_index = newRow.insertCell(0);
		const td_begin = newRow.insertCell(1);
		const td_end = newRow.insertCell(2);
		const td_times = newRow.insertCell(3);
		const td_type = newRow.insertCell(4);
		const cell5  = newRow.insertCell(5);
		const td_play  = newRow.insertCell(6);

		var td_download = document.createElement("button");
		td_download.id = "rowBtn"+INDEX
		td_download.innerHTML = "下载";
		td_download.addEventListener("click",function(){
			// console.log(td_download.id)
			downloadVideo(td_download.id)
		})
		// console.log(td_download)
		cell5.appendChild(td_download)
		td_play.innerHTML = "<a href=\"javascript:playRecord(" + file_begintime + "," + file_endtime + ", " + file_type + ","+td_download.id+")\">Play</a>";

		td_index.innerText = INDEX
		td_begin.innerText = new Date((file_begintime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();	
		td_end.innerText = new Date((file_endtime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
		td_times.innerText = file_endtime - file_begintime;
		if(file_type == 1){
			td_type.innerText = "日程录像"
		}
		else{
			td_type.innerText = "报警录像";
		}		

		td_index.style = "border:solid 1px black"
		td_begin.style = "border:solid 1px black"
		td_end.style = "border:solid 1px black"
		td_times.style = "border:solid 1px black"
		td_type.style = "border:solid 1px black"
		cell5.style = "border:solid 1px black"
		td_play.style = "border:solid 1px black"
		
		// var tr = document.createElement("tr");
		// console.log(file_type, file_begintime, file_endtime,INDEX)

		// var td_index = document.createElement("td");
		// var td_begin = document.createElement("td");
		// var td_end = document.createElement("td");
		// var td_times = document.createElement("td");
		// var td_type = document.createElement("td");
		// var td_download = document.createElement("button");
		// td_download.id = "rowBtn"+INDEX
		// td_download.innerHTML = "下载";
		// td_download.addEventListener("click",function(){
		// 	// console.log(td_download.id)
		// 	downloadVideo(td_download.id)
		// })
		// console.log(td_download)

		// td_index.innerText = INDEX
		// td_begin.innerText = new Date((file_begintime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();	
		// td_end.innerText = new Date((file_endtime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
		// td_times.innerText = file_endtime - file_begintime;
		// if(file_type == 1){
		// 	td_type.innerText = "日程录像"
		// }
		// else{
		// 	td_type.innerText = "报警录像";
		// }		

		// td_index.style = "border:solid 1px black"
		// td_begin.style = "border:solid 1px black"
		// td_end.style = "border:solid 1px black"
		// td_times.style = "border:solid 1px black"
		// td_type.style = "border:solid 1px black"

		// tr.appendChild(td_index);
		// tr.appendChild(td_begin);
		// tr.appendChild(td_end);
		// tr.appendChild(td_times);
		// tr.appendChild(td_type);
		// tr.appendChild(td_download);

		// var recListTable = document.getElementById("recListTable");
		// console.log(recListTable)
		// recListTable.appendChild(tr);
	}

	
	// 远程设置 - 区域侦测（区域入侵）
	const maxRows = 24; // 区域侦测 - 画面最大行数
	const maxColumns = 32; // 区域侦测 - 画面最大列数

	const gridBox = document.getElementById('gridBox')
	const perWidth = (gridBox.offsetWidth / maxColumns).toFixed(3) // 每个格子宽度
	const perHeight = (gridBox.offsetHeight / maxRows).toFixed(3) // 每个格子高度

	let startPoint = {}  // 起始坐标
	let endPoint = {} // 终止坐标

	// 划线模式
	function drawLineMode() {
	}
	//关闭区域侦测回显数据
	function closeDrawArea(){
		document.getElementById('gridBox').style.display = "none"
		let domArr = document.getElementsByClassName("item")
		for(var i=0;i<domArr.length;i++){
			domArr[i].style.background = "rgba(0, 0, 0, 0.3)"
		}
	}
	// 区域模式
	function drawAreaMode() {
		document.getElementById('gridBox').style.display = ""
		var id = document.getElementById("dev_id").value;
		let session = GetSessionById(id);
		if (!session) {
			alert("请先连接设备（页面左上角点击‘连接设备’）");
			return
		}
		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;		

		let config = {
			"Version": "1.3.0",
			"Method": "get",
			"IPCam": {
				"AlarmSetting":{
					"MotionDetection":{
					}
				},
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
   		 };

		sendRemoteConfig(config);

		const GRID_BOX = document.getElementById('gridBox')
		var items = document.querySelectorAll("#gridBox .item");
		for (var i = 0; i < items.length; i++) {
			items[i].remove();
		}
		const widthPercentage = (100 / maxColumns).toFixed(3)
		const heightPercentage = (100 / maxRows).toFixed(3)
		let fragment = document.createDocumentFragment()
		for (let i = 0; i < maxRows; i++) {
			for (let j = 0; j < maxColumns; j++) {
				var div = document.createElement("div");
				div.style.width = widthPercentage + '%'
				div.style.height = heightPercentage + '%'
				div.className = 'item'
				fragment.appendChild(div)
			}
		}
		setTimeout(() => {
			GRID_BOX.appendChild(fragment)
		}, 10)

		var promise = drawScreenPromise();
        promise.then(function (data) {
			var jArr = binaryStr.split('')
			var areaArr = []
			for(var i=0;i<girdData.length;i++){
				for(var j=0;j<jArr.length;j++){
					if(girdData[i] == 0){
						areaArr.push(0)
					}else{
						areaArr.push(jArr[j])
					}
				}
			}
			let domArr = document.getElementsByClassName("item")
			for(var i=0;i<areaArr.length;i++){
				if(areaArr[i] ==1){
					domArr[i].style.background = "#ff3333"
					domArr[i].style.opacity  = ".5"
				}else{
					domArr[i].style.background = "rgba(0, 0, 0, 0.3)"
				}
			}
        })

	}
	
	var drawScreenPromise = function drawScreenPromise() {
		var promise = new Promise(function (resolve, reject) {
			var timeOut = setTimeout(function () {
			var decimalNum = null;
			var binaryStr = null;
			for(var i=0;i<window.girdData.length;i++){
				if(window.girdData[i]>0){
						decimalNum =  window.girdData[i]
						let binaryStr = decimalNum.toString(2);
						while (binaryStr.length < 32) {
							binaryStr = '0' + binaryStr;
						}
						window.binaryStr = binaryStr
						console.log(binaryStr);
						return resolve(true);
				}
			}
			clearTimeout(timeOut);
			}, 1000);
		});
		return promise;
	};
	// 起始坐标
	function getStartPoint() {
		const area = document.getElementById('area')
		document.getElementById('gridBox').onmousedown = function (event) {
			let start = {}
			start.x = event.layerX
			start.y = event.layerY
			startPoint.x = Math.ceil(event.layerX / perWidth) - 1
			startPoint.y = Math.ceil(event.layerY / perHeight) - 1
			console.log('Down! Start X is', startPoint.x, ', Start Y is', startPoint.y);

			area.style.left = start.x + 'px'
			area.style.top = start.y + 'px'
			area.style.border = '1px solid red'
			document.getElementById('gridBox').onmousemove = function (event) {
				event.preventDefault()
				area.style.width = event.offsetX - start.x + 'px'
				area.style.height = event.offsetY - start.y + 'px'
			}
		}
	}
	// 终止坐标
	function getEndPoint() {
		document.getElementById('gridBox').onmouseup = function (event) {
			event.preventDefault()
			endPoint.x = Math.ceil(event.layerX / perWidth) - 1
			endPoint.y = Math.ceil(event.layerY / perHeight) - 1
			console.log('Up! End X is', endPoint.x, ', End Y is', endPoint.y);

			document.getElementById('gridBox').onmousemove = null
			area.style.width = 0
			area.style.height = 0
			area.style.border = '0'
		}
	}

	// 远程设置 - 区域侦测（区域入侵）
	function setRegionMotionDetection() {
		let top = startPoint.y; // 起始行
		let left = startPoint.x; // 起始列
		let bottom = endPoint.y; // 结束行
		let right = endPoint.x; // 结束列



		// let grid = [];
		// for (let i = 0; i < maxRows; i++) { // 行
		// 	for (let j = 0; j < maxColumns; j++) { // 列
		// 		let val = 0;
		// 		if (i >= top && i <= bottom && j >= left && j <= right) {
		// 			val = 1;
		// 		}
		// 		if (j < 31) {// js int 是有符号的，所以最多移到30位
		// 			grid[i] = (0 == j ? val : grid[i] << 1);
		// 		}
		// 		grid[i] |= val
		// 	}
		// }

		let grid = [];
		for (let i = 0; i < maxRows; i++) { // 行
			for (let j = 0; j < maxColumns; j++) { // 列
				let val = 0;
				if (i >= top && i <= bottom && j >= left && j <= right) {
					val = 1;
				}
				if (j < 31) {// js int 是有符号的，所以最多移到30位
					grid[i] = (0 == j ? val : grid[i] << 1);
				}
				if(j==31){
						if(0==j){
							grid[i] = val
						}else{
							let num1 = grid[i]; 
							let num2 = 1n;  
							let shiftedNum = BigInt(num1) << num2;  
							grid[i] = shiftedNum.toString();  
						}
                }
				grid[i] |= val
			}
		}
		
		let nums = grid;  
		let strNums = [];  
		for (let i = 0; i < nums.length; i++) {  
			let strNum = nums[i]
			if(nums[i]<0){
				strNum = nums[i]+ Math.pow(2, 32)
				
			}
			strNums.push(strNum);  
		}
		grid = strNums
		console.log('[setRegionMotionDetection] grid:', grid);

		var user = document.getElementById("user").value;
		var pwd = document.getElementById("pwd").value;

		let config = {
			"Version": "1.3.0",
			"Method": "set",
			"IPCam": {
				"AlarmSetting": {
					// 
					"MotionDetection": {
						"Enabled": true, // 运动侦测开关
						"MotionRecord": true, // 移动侦测录像开关
						"SensitivityLevel": "normal", // 灵敏度水平可选项[“lowest”,”low”,”normal”,”high”,”highest”]
						"MotionWarningTone": true, // 使能报警声音
						"Duration": 20, // 报警声音持续时间 (秒)
						"motionTrackEnabled": true, // 移动跟踪开关
						"type": "region", // 侦测类型“line”,”region”
						"line": [],
						"grid": grid
					},
					"MessagePushEnabled": true
				},
			},
			"Authorization": {
				"Verify": '',
				"username": user,
				"password": pwd
			}
		};

		sendRemoteConfig(config);
	}

	function startRecord(){
		Player.ctrlRecordOn(0, 'video.mp4',  null, null)
	}

	function endRecord(){
		Player.ctrlRecordOff(0)
	}
	window.sharedevid = document.getElementById("dev_id").value;
	window.sharechannel = document.getElementById("channel").value;

	function playRecord(tBegin, tEnd, tType,index){
		var devid = document.getElementById("dev_id").value;
		var channel = document.getElementById("channel").value;
		Player.StartPlayBack(devid, '', channel, tBegin, tEnd, 255, 0, false,0);
		document.getElementById("div_recList").style.display="none";

		var videoList = getRecordList()
		var num = index.id.slice(6)
		
		var startTime = videoList[videoList.length - num-1].file_begintime
		var endTime = videoList[videoList.length - num-1].file_endtime
		document.getElementById("startTime").innerHTML =new Date((startTime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
		document.getElementById("endTime").innerHTML = new Date((endTime+ new Date().getTimezoneOffset() *60) * 1000).toLocaleString();
	}
</script>

</html>